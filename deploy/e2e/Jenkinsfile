// pipeline {
//     agent { label env.DEPLOYMENT_ENV }

//     environment {
//         NODE_OPTIONS = "--max-old-space-size=8192"
//         NVM_DIR = "$HOME/.nvm"
//     }

//     stages {
//         stage('Run Tests') {
//             steps {
//                 sh '''
//                     echo "Checking if NVM is installed..."
//                     if [ ! -s "$NVM_DIR/nvm.sh" ]; then
//                         echo "NVM not found. Installing NVM..."
//                         curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash
//                         [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
//                         echo "NVM installed successfully."
//                     else
//                         echo "NVM is already installed."
//                         [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
//                     fi

//                     echo "Checking Node.js version..."
//                     if ! nvm use 20.9.0; then
//                         echo "Node.js 20.9.0 not installed. Installing Node.js 20.9.0..."
//                         nvm install 20.9.0
//                     fi
//                     nvm use 20.9.0
//                     echo "Node.js version:"
//                     node -v

//                     pnpm install
//                     rm -f jest_html_reporters.html

//                     # Running tests with dotenv environment variables
//                     pnpm test:e2e --json --unhandled-rejections=strict --outputFile='e2e-test-results.json' $TEST_SUITE
//                 '''
//             }
//         }
//     }

//     post {
//         always {
//             sh '''
//                 [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
//                 nvm use 20.9.0
//                 node jest-result-processor.js

//                 # Organize and archive reports
//                 rm -rf reports
//                 mkdir reports
//                 mv jest_html_reporters.html ./reports
//             '''
//             allure([
//                 includeProperties: false,
//                 reportBuildPolicy: 'ALWAYS',
//                 results: [[path: 'allure-results']]
//             ])
//             publishHTML(target: [
//                 allowMissing: true,
//                 alwaysLinkToLastBuild: true,
//                 keepAll: true,
//                 reportDir: 'jest-stare',
//                 reportFiles: 'index.html',
//                 reportName: "Jest Stare"
//             ])
//             publishHTML(target: [
//                 allowMissing: true,
//                 alwaysLinkToLastBuild: true,
//                 keepAll: true,
//                 reportDir: 'reports',
//                 reportFiles: 'jest_html_reporters.html',
//                 reportName: "E2E Report"
//             ])
//         }
//         aborted {
//             echo "E2E Tests aborted."
//         }
//         success {
//             echo "E2E Tests completed successfully."
//         }
//         unstable {
//             echo "E2E Tests encountered issues but completed."
//         }
//         failure {
//             echo "E2E Tests failed! Please check the logs."
//         }
//     }
// }

pipeline {
    agent any

    environment {
        // Optional: You can set environment variables here, such as the Node version
        NODE_VERSION = '16.x' // Change as per your requirement
    }

    stages {
        stage('Install Dependencies') {
            steps {
                script {
                    // Install Node.js and dependencies using npm
                    // If you're using a different package manager like pnpm, replace `npm install` with the appropriate command
                    sh 'pnpm install'
                }
            }
        }

        stage('Run Jest Tests') {
            steps {
                script {
                    // Run Jest tests using npm
                    // If you have a custom command for Jest, replace `npm run test` accordingly
                    sh 'pnpm run test -- --ci --verbose' // `--ci` is used to run tests in CI mode
                }
            }
        }
    }

    post {
        always {
            // Always run this block, regardless of success or failure
            echo 'Cleaning up...'
            // Add any cleanup commands here, if necessary
        }
        success {
            // Actions to take if the build is successful
            echo 'Tests passed successfully!'
        }
        failure {
            // Actions to take if the build fails
            echo 'Tests failed. Check the logs for details.'
        }
    }
}
